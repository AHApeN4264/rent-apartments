{% extends 'base.html' %}
{% load static %}

{% block title %}
    <title>{{ title }}</title>
    <link rel="icon" type="image/x-icon" href="{% static 'icons/icons8-brutus-32.ico' %}">
    <link rel="stylesheet" href="{% static 'css/rent.css' %}">
{% endblock %}

{% block body %}
<div class="username-display">
  {% if user.username %}
    <a href="/settings" class="login-link">üë§ {{ user.username }}</a>
    <a href="/wallet" class="login-link">({{ user.wallet }})</a>
  {% else %}
    üë§ –í–∏ –Ω–µ —É–≤—ñ–π—à–ª–∏ –≤ –∞–∫–∞—É–Ω—Ç<br>
    <a href="/login" class="login-link">–£–≤—ñ–π—Ç–∏</a>
  {% endif %}
  <div class="switch-wrapper">
    <label class="switch" title="–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ —Ç–µ–º—É">
      <input type="checkbox" id="themeToggle" aria-label="Theme toggle">
      <span class="slider"></span>
    </label>
  </div>
</div>

<div class="background">
  <div class="container">
    {% if messages %}
      {% for message in messages %}
        <p class="
          {% if 'success' in message.tags %}message
          {% elif 'error' in message.tags %}error-msg
          {% else %}info-msg
          {% endif %}
        ">
          {{ message }}
        </p>
      {% endfor %}
    {% endif %}
    <form method="post">
        <h1>–û—Ä–µ–Ω–¥—É–≤–∞—Ç–∏ –∫—ñ–º–Ω–∞—Ç—É</h1>
        {% csrf_token %}  
    
        <label>–í–∞—à–µ —ñ–º'—è:
            <input type="text" value="{{ user.username }}" readonly>
        </label>  
      
        <p style="margin: 0; font-weight: bold;">–¶—ñ–Ω–∞ –∑–∞ –¥–µ–Ω—å:
            <span id="daily_price_display">{{ room.price }}</span> –≥—Ä–Ω
        </p>
        <br>  
      
        <label>–î–∞—Ç–∞ –ø–æ—á–∞—Ç–∫—É –∑–∞–π–Ω—è—Ç–æ—Å—Ç—ñ:
            <input type="date" name="first_data" id="start_date" value="{{ tomorrow }}" min="{{ tomorrow }}" required>
        </label>  
      
        <label>–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –∑–∞–π–Ω—è—Ç–æ—Å—Ç—ñ:
            <input type="date" name="last_data" id="end_date" value="{{ tomorrow }}" min="{{ tomorrow }}" required>
        </label>  
      
        <label>–ó–∞–≥–∞–ª—å–Ω–∞ —Ü—ñ–Ω–∞:
            <span id="total_price_display" style="font-weight: bold;"></span>
        </label>         

        <label>–í–∞—à –±–∞–ª–∞–Ω—Å: <strong id="wallet_balance">{{ user.wallet }}</strong> –≥—Ä–Ω</label>
        <p id="balance_remaining" style="font-weight: bold; margin-top: 5px;"></p>
        <p id="balance_warning" style="color: red; font-weight: bold; display: none;">
          –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤ –¥–ª—è –æ—Ä–µ–Ω–¥–∏
        </p>
        

        <br><br>
        <button type="submit">–û—Ä–µ–Ω–¥—É–≤–∞—Ç–∏</button>

    </form>
  </div>
</div>

<div id="menu" class="styled-button" onclick="redirectToMenu()">
  üî•
  <span style="color: #6a5acd; text-decoration: none; font-weight: bold;">–ú–µ–Ω—é</span>
  üî•
</div>

<script>
    function redirectToMenu() {
        window.location.href = "/menu/{{ user.id }}";
    }
</script>

<script>
  const startDateInput = document.getElementById('start_date');
  const endDateInput = document.getElementById('end_date');
  const dailyPrice = parseFloat(document.getElementById('daily_price_display').textContent);
  const totalPriceDisplay = document.getElementById('total_price_display');
  const walletBalance = parseFloat(document.getElementById('wallet_balance').textContent);
  const balanceWarning = document.getElementById('balance_warning');
  const balanceRemainingElem = document.getElementById('balance_remaining');
  const rentButton = document.querySelector('button[type="submit"]');

  function getDayWord(days) {
    if (days === 1) return '–¥–µ–Ω—å';
    if (days >= 2 && days <= 4) return '–¥–Ω—ñ';
    return '–¥–Ω—ñ–≤';
  }

  function updateTotalPrice() {
    const start = new Date(startDateInput.value);
    const end = new Date(endDateInput.value);

    if (!isNaN(start) && !isNaN(end) && end >= start) {
      const diffTime = end - start;
      const days = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
      const total = days * dailyPrice;
      const dayWord = getDayWord(days);
      totalPriceDisplay.textContent = `${total} –≥—Ä–Ω –∑–∞ ${days} ${dayWord}`;

      const balanceRemaining = walletBalance - total;
      if (balanceRemaining >= 0) {
        balanceRemainingElem.textContent = `–ó–∞–ª–∏—à–æ–∫ –ø—ñ—Å–ª—è –æ—Ä–µ–Ω–¥–∏: ${balanceRemaining.toFixed(2)} –≥—Ä–Ω`;
        balanceWarning.style.display = 'none';
        rentButton.disabled = false;
        rentButton.style.backgroundColor = '#007bff';
        rentButton.style.cursor = 'pointer';
      } else {
        balanceRemainingElem.textContent = '';
        balanceWarning.style.display = 'block';
        rentButton.disabled = true;
        rentButton.style.backgroundColor = '#ccc';
        rentButton.style.cursor = 'not-allowed';
      }
    } else {
      totalPriceDisplay.textContent = '';
      balanceRemainingElem.textContent = '';
      balanceWarning.style.display = 'none';
      rentButton.disabled = true;
      rentButton.style.backgroundColor = '#ccc';
      rentButton.style.cursor = 'not-allowed';
    }
  }

  startDateInput.addEventListener('change', updateTotalPrice);
  endDateInput.addEventListener('change', updateTotalPrice);

  document.addEventListener('DOMContentLoaded', updateTotalPrice);
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const toggle = document.getElementById("themeToggle");
    const html = document.documentElement;

    if (localStorage.getItem("darkTheme") === "true") {
      html.classList.add("dark-theme");
      toggle.checked = true;
    }

    toggle.addEventListener("change", function () {
      html.classList.toggle("dark-theme", this.checked);
      localStorage.setItem("darkTheme", this.checked);
    });
  });
</script>

{% endblock %}
